<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Manutenzioni Enterprise</title>
    
    <link rel="icon" type="image/png" href="favicon.png">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --theme-color: #d32f2f; --bg-color: #f5f5f5; --text-color: #2b2b2b; --card-bg: #ffffff; --header-bg: #1a1a1a; --border-color: #ddd; --input-bg: #ffffff; --table-hover: #f9f9f9; }
        [data-theme="dark"] { --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e; --header-bg: #000000; --border-color: #333333; --input-bg: #2d2d2d; --table-hover: #2a2a2a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; }
        
        #loginScreen { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: var(--header-bg); flex-direction: column; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 100%; max-width: 400px; text-align: center; border-top: 5px solid var(--theme-color); }
        .login-box input { margin-bottom: 15px; width: 100%; padding: 12px; }
        .login-box h2 { margin-top: 0; color: var(--text-color); }

        #appContent { display: none; }
        header { background-color: var(--header-bg); color: #ffffff; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container h1 { margin: 0; font-size: 24px; font-weight: 400; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .header-btn { background-color: transparent; color: #ffffff; border: 1px solid #ffffff; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .header-btn:hover { background-color: var(--theme-color); border-color: var(--theme-color); }
        .user-badge { background: #333; padding: 5px 10px; border-radius: 20px; font-size: 12px; color: #aaa; }

        .dashboard-wrapper { max-width: 1400px; margin: 0 auto; padding: 20px 30px 0 30px; }
        .filter-bar { background: var(--card-bg); padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; border-left: 5px solid var(--theme-color); }
        .filter-bar select, .filter-bar input[type="month"] { width: auto; min-width: 200px; padding: 8px; font-size: 16px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); }
        .dashboard-container { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .stat-card { flex: 1; min-width: 250px; background: var(--card-bg); padding: 20px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #888; text-transform: uppercase; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: var(--theme-color); }
        .charts-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .chart-card { flex: 1; min-width: 300px; background: var(--card-bg); padding: 20px; border-radius: 8px; }
        
        .main-content { display: flex; gap: 20px; padding: 20px 30px; max-width: 1400px; margin: 0 auto; flex-wrap: wrap; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 8px; border-top: 4px solid var(--theme-color); }
        .form-section { flex: 1; min-width: 300px; }
        .table-section { flex: 2; min-width: 600px; overflow-x: auto; }
        h2 { margin-top: 0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--text-color); border-radius: 4px; box-sizing: border-box; }
        
        .btn-primary { background-color: var(--theme-color); color: #ffffff; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; }
        .btn-secondary { background-color: #555; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border-bottom: 1px solid var(--border-color); padding: 10px; text-align: left; }
        th { background-color: var(--header-bg); color: #ffffff; }
        tr:hover { background-color: var(--table-hover); }
        .btn-small { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; color: white; margin-right: 5px; }
        .btn-pdf { background-color: #007bff; }
        .btn-delete { background-color: #dc3545; }
        .btn-foto { background-color: #17a2b8; text-decoration: none; display: inline-block; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 900px; border-radius: 8px; padding: 25px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--theme-color); padding-bottom: 10px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color); }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .flex-row { display: flex; gap: 10px; align-items: flex-end; }
        hr { border: 0; border-top: 1px solid var(--border-color); margin: 20px 0; }
        .impianto-item { background: var(--input-bg); padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid var(--border-color); }
        .impianto-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }

        .operator-hidden { display: none !important; }

        /* Stampa PDF */
        @media print {
            @page { margin: 10mm; }
            body * { visibility: hidden; }
            #pdfTemplate, #pdfTemplate * { visibility: visible; }
            #pdfTemplate { position: absolute; left: 0; top: 0; width: 100%; padding: 0 !important; background: white !important; }
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <img src="logo.png" alt="Logo Azienda" style="max-height: 90px; margin-bottom: 15px; object-fit: contain;">
            <h2>Accesso Manutenzioni</h2>
            <form id="loginForm">
                <input type="email" id="email" placeholder="Email Operatore / Admin" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn-primary" id="loginBtn">Accedi al Sistema</button>
            </form>
            <p id="loginError" style="color: #ff5252; font-size: 14px; display: none;"></p>
        </div>
    </div>

    <div id="appContent">
        
        <div id="pdfTemplate" style="display: none; padding: 40px; font-family: 'Segoe UI', Helvetica, Arial, sans-serif; color: #333; background: #fff; width: 100%; max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--theme-color); padding-bottom: 15px; margin-bottom: 30px;">
                <img src="logo.png" alt="Logo" style="max-height: 70px; object-fit: contain;">
                <div style="text-align: right;">
                    <h1 style="margin: 0; color: #1a1a1a; font-size: 26px; text-transform: uppercase;">Scheda Intervento</h1>
                    <p id="pdfTitoloAzienda" style="margin: 5px 0 0 0; color: #666; font-size: 14px; font-weight: bold;"></p>
                </div>
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 14px;">
                <tr>
                    <td style="padding: 12px; border: 1px solid #ddd; background: #f4f7f6; width: 20%;"><strong>Data:</strong></td>
                    <td style="padding: 12px; border: 1px solid #ddd; width: 30%; font-weight: bold;" id="pdfData"></td>
                    <td style="padding: 12px; border: 1px solid #ddd; background: #f4f7f6; width: 20%;"><strong>Tipo:</strong></td>
                    <td style="padding: 12px; border: 1px solid #ddd; width: 30%; font-weight: bold; color: var(--theme-color);" id="pdfCausa"></td>
                </tr>
                <tr>
                    <td style="padding: 12px; border: 1px solid #ddd; background: #f4f7f6;"><strong>Impianto:</strong></td>
                    <td style="padding: 12px; border: 1px solid #ddd;" id="pdfImpianto"></td>
                    <td style="padding: 12px; border: 1px solid #ddd; background: #f4f7f6;"><strong>Macchina:</strong></td>
                    <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; font-size: 16px;" id="pdfMacchina"></td>
                </tr>
                <tr>
                    <td style="padding: 12px; border: 1px solid #ddd; background: #f4f7f6;"><strong>Operatore:</strong></td>
                    <td colspan="3" style="padding: 12px; border: 1px solid #ddd;" id="pdfOperatore"></td>
                </tr>
            </table>
            <div style="margin-bottom: 40px;">
                <h3 style="margin-bottom: 10px; font-size: 16px; color: #1a1a1a; text-transform: uppercase; border-bottom: 2px solid #ddd; padding-bottom: 5px;">Descrizione Lavoro e Ricambi</h3>
                <div id="pdfMateriale" style="padding: 15px; background: #fafafa; border: 1px solid #eee; min-height: 100px; white-space: pre-wrap; font-size: 14px; line-height: 1.5;"></div>
            </div>
            
            <div id="pdfContainerFoto" style="display: none; text-align: center; margin-bottom: 20px;">
                <h3 style="font-size: 14px; text-transform: uppercase; color: #666; margin-bottom: 10px;">Foto Allegata</h3>
                <img id="pdfFotoIntervento" src="" style="max-width: 100%; max-height: 350px; border: 1px solid #ddd; padding: 5px; border-radius: 4px;">
            </div>

            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 50px;">
                <div style="font-size: 16px; background: #f4f7f6; padding: 15px; border-radius: 4px; border: 1px solid #ddd;">
                    <strong>Ore Impiegate:</strong> 
                    <span id="pdfOre" style="font-size: 22px; color: var(--theme-color); font-weight: bold; margin-left: 10px;"></span> h
                </div>
                <div style="display: flex; gap: 30px;">
                    <div style="border-top: 1px solid #333; width: 200px; text-align: center; padding-top: 8px; font-size: 14px;">Firma del Tecnico</div>
                    <div style="border-top: 1px solid #333; width: 200px; text-align: center; padding-top: 8px; font-size: 14px;">Firma del Responsabile</div>
                </div>
            </div>
        </div>

        <header>
            <div class="logo-container">
                <img src="logo.png" alt="Logo" style="max-height: 70px; margin-right: 15px; object-fit: contain;">
                <h1 id="siteTitle">Registro Manutenzioni</h1>
            </div>
            <div class="header-actions">
                <span id="userBadge" class="user-badge">Verifica in corso...</span>
                <button id="btnImpostazioni" class="header-btn" onclick="apriImpostazioni()">‚öôÔ∏è Impostazioni</button>
                <button class="header-btn" onclick="eseguiLogout()" style="background: transparent; border: 1px solid #aaa;">Esci</button>
            </div>
        </header>

        <div class="dashboard-wrapper" id="pannelloStatistiche">
            <div class="filter-bar">
                <strong>üìÖ Filtra Analisi: </strong>
                <select id="filtroTempo" onchange="cambiaFiltro()">
                    <option value="all" selected>Storico Completo (Tutto)</option>
                    <option value="today">Oggi</option>
                    <option value="7days">Ultimi 7 Giorni</option>
                    <option value="30days">Ultimi 30 Giorni</option>
                    <option value="this_year">Anno Corrente</option>
                    <option value="specific_month">Scegli Mese Specifico ‚û°Ô∏è</option>
                </select>
                <input type="month" id="sceltaMese" style="display:none;" onchange="aggiornaVista()">
            </div>
            <div class="dashboard-container">
                <div class="stat-card"><h3>Ore Totali</h3><div class="value" id="statOre">0 h</div></div>
                <div class="stat-card"><h3>Costo Stimato</h3><div class="value" id="statCosti">0,00 ‚Ç¨</div></div>
                <div class="stat-card"><h3>Macchina pi√π problematica</h3><div class="value" id="statMacchina" style="font-size: 18px;">-</div></div>
            </div>
            <div class="charts-container">
                <div class="chart-card"><canvas id="graficoCause"></canvas></div>
                <div class="chart-card" style="flex: 2;"><canvas id="graficoMacchine"></canvas></div>
            </div>
        </div>

        <div class="main-content">
            <div class="card form-section">
                <h2>Nuovo Intervento</h2>
                <form id="manutenzioneForm">
                    <div class="form-group"><label>Data</label><input type="date" id="data" required></div>
                    <div class="form-group"><label>Operatore / Tecnico</label><input type="text" id="operatore" required></div>
                    <div class="form-group"><label>Impianto</label><select id="impiantoSelect" required onchange="aggiornaMacchineForm()"><option value="" disabled selected></option></select></div>
                    <div class="form-group"><label>Macchina</label><select id="macchinaSelect" required><option value="" disabled selected></option></select></div>
                    <div class="form-group"><label>Tipologia</label><select id="causa" required></select></div>
                    <div class="form-group"><label>Ore di Lavoro</label><input type="number" id="ore" step="0.5" min="0" required></div>
                    <div class="form-group"><label>Note / Ricambi usati</label><textarea id="materiale" rows="3"></textarea></div>
                    
                    <div class="form-group" style="background: #f4f7f6; padding: 15px; border-radius: 4px; border: 1px dashed var(--theme-color);">
                        <label style="color: var(--theme-color);">üì∑ Allega Foto (Opzionale)</label>
                        <input type="file" id="fotoIntervento" accept="image/*" capture="environment" style="border: none; background: transparent; padding: 0;">
                        <small style="color: #666; display: block; margin-top: 5px;">Scatta dal tablet o carica dal PC.</small>
                    </div>

                    <button type="submit" class="btn-primary">Registra Intervento</button>
                </form>
            </div>

            <div class="card table-section">
                <h2>Storico Interventi</h2>
                <table>
                    <thead><tr><th>Data</th><th>Impianto</th><th>Macchina</th><th>Tipo</th><th>Ore</th><th>Operatore</th><th>Dettagli</th><th>Azioni</th></tr></thead>
                    <tbody id="tabellaStorico"><tr><td colspan="8" style="text-align:center;">Caricamento...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><h2 style="margin:0; border:none;">‚öôÔ∏è Impostazioni Admin</h2><button class="close-btn" onclick="chiudiImpostazioni()">&times;</button></div>
                <div class="settings-grid">
                    <div>
                        <h3>Personalizzazione</h3>
                        <div class="form-group"><label></label><div class="flex-row"><input type="text" id="setNometitolo"><button onclick="salvaImpostazioneBase('titoloAzienda', 'setNometitolo', 'siteTitle')" class="btn-secondary" style="width:auto;">Salva</button></div></div>
                        <div class="flex-row"><div class="form-group" style="flex:1;"><label>Colore Tema</label><input type="color" id="setColoreTema" style="height:40px; padding:0; cursor:pointer;"></div><button onclick="salvaColoreTema()" class="btn-secondary" style="height:40px; margin-bottom:15px;">Applica</button></div>
                        <div class="form-group"><label><input type="checkbox" id="themeToggle" onchange="toggleTema()"> Abilita Dark Mode</label></div>
                        <div class="form-group" style="margin-top:20px;"><label>Costo Orario Manodopera (‚Ç¨/h)</label><div class="flex-row"><input type="number" id="setCostoOrario" step="0.1" min="0"><button onclick="salvaImpostazioneBase('costoOrario', 'setCostoOrario', null)" class="btn-secondary" style="width:auto;">Salva</button></div></div>
                        <hr><button onclick="esportaCSV()" class="btn-primary" style="background-color: #2e7d32;">‚¨áÔ∏è Esporta Dati (Excel CSV)</button>
                    </div>
                    <div>
                        <h3>Categorie Intervento</h3>
                        <div class="flex-row form-group"><input type="text" id="nuovaCategoria"><button onclick="aggiungiCategoria()" class="btn-secondary" style="width:auto;">Aggiungi</button></div>
                        <ul id="listaCategorie" style="font-size:13px; margin-bottom:20px;"></ul>
                        <hr>
                        <h3>Struttura Impianti</h3>
                        <div class="form-group"><label>Nome Impianto</label><input type="text" id="nuovoImpianto"></div>
                        <div class="form-group"><label>Macchinari (separati da virgola)</label><input type="text" id="nuoveMacchine"></div>
                        <button onclick="aggiungiImpiantoFirebase()" class="btn-secondary">Aggiungi / Aggiorna</button>
                        <h4 style="margin-top: 20px;">Impianti Salvati:</h4>
                        <div id="strutturaImpiantiRender" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // INSERISCI QUI LE TUE CHIAVI FIREBASE!
        // ==========================================
        const firebaseConfig = {
            ¬†apiKey: "AIzaSyAb5R2aeHVkpBhYOLwHCwtnfoW7R5zGeO4",
¬† authDomain: "manutenzione-d2f13.firebaseapp.com",
¬† projectId: "manutenzione-d2f13",
¬† storageBucket: "manutenzione-d2f13.firebasestorage.app",
¬† messagingSenderId: "145108065762",
¬† appId: "1:145108065762:web:df1b4edc7c305cbf32adbb"

        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();
        
        let datiCorrenti = []; let datiFiltrati = []; let strutturaAzienda = {}; 
        let chartCauseInstance = null; let chartMacchineInstance = null;
        let filtroTempoAttuale = 'all'; let currentUserRole = 'operatore'; 

        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('loginScreen').style.display = 'none'; document.getElementById('appContent').style.display = 'block'; document.getElementById('userBadge').innerText = user.email;
                db.collection("utenti").doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().ruolo === 'admin') { currentUserRole = 'admin'; document.getElementById('userBadge').innerText += " (ADMIN)"; } 
                    else { currentUserRole = 'operatore'; document.getElementById('userBadge').innerText += " (OPERATORE)"; }
                    avviaApplicazione(); 
                }).catch(err => { currentUserRole = 'operatore'; avviaApplicazione(); });
            } else {
                document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('appContent').style.display = 'none';
            }
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault(); const btn = document.getElementById('loginBtn'); const errBox = document.getElementById('loginError');
            btn.innerText = "Accesso..."; btn.disabled = true; errBox.style.display = 'none';
            auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
                .then(() => { btn.innerText = "Accedi"; btn.disabled = false; })
                .catch((error) => { errBox.innerText = error.message; errBox.style.display = 'block'; btn.innerText = "Accedi"; btn.disabled = false; });
        });

        function eseguiLogout() { auth.signOut(); }

        function applicaPermessiUI() {
            const btnImp = document.getElementById('btnImpostazioni'); const pannelloStat = document.getElementById('pannelloStatistiche');
            if (currentUserRole === 'operatore') { btnImp.classList.add('operator-hidden'); pannelloStat.classList.add('operator-hidden'); } 
            else { btnImp.classList.remove('operator-hidden'); pannelloStat.classList.remove('operator-hidden'); }
            renderTabella(datiFiltrati); 
        }

        let categorieLavoro = JSON.parse(localStorage.getItem('categorieLavoro')) || ["Ordinaria", "Guasto", "Preventiva", "Miglioramento"];

        function avviaApplicazione() {
            document.getElementById('siteTitle').innerText = localStorage.getItem('titoloAzienda') || "Registro Manutenzioni";
            document.getElementById('setNometitolo').value = localStorage.getItem('titoloAzienda') || "";
            document.getElementById('setCostoOrario').value = localStorage.getItem('costoOrario') || "0";
            let colore = localStorage.getItem('coloreTema') || "#d32f2f"; document.documentElement.style.setProperty('--theme-color', colore); document.getElementById('setColoreTema').value = colore;
            let isDarkMode = localStorage.getItem('darkMode') === 'true'; document.getElementById('themeToggle').checked = isDarkMode; if(isDarkMode) document.body.setAttribute('data-theme', 'dark');
            Chart.defaults.color = isDarkMode ? '#e0e0e0' : '#2b2b2b'; document.getElementById('data').valueAsDate = new Date();
            applicaPermessiUI(); aggiornaListaCategorie(); caricaStrutturaImpianti(); caricaDatiStorico(); 
        }

        function cambiaFiltro() { 
            filtroTempoAttuale = document.getElementById('filtroTempo').value; 
            if(filtroTempoAttuale === 'specific_month') {
                document.getElementById('sceltaMese').style.display = 'inline-block';
            } else {
                document.getElementById('sceltaMese').style.display = 'none';
            }
            aggiornaVista(); 
        }

        function aggiornaVista() {
            const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            if (filtroTempoAttuale === 'all') { datiFiltrati = [...datiCorrenti]; } 
            else {
                datiFiltrati = datiCorrenti.filter(record => {
                    
                    if (filtroTempoAttuale === 'specific_month') {
                        const meseScelto = document.getElementById('sceltaMese').value; 
                        if (!meseScelto) return true; 
                        return record.data.startsWith(meseScelto); 
                    }

                    const d = new Date(record.data);
                    if (filtroTempoAttuale === 'today') return d >= today;
                    if (filtroTempoAttuale === '7days') return d >= new Date(new Date().setDate(today.getDate() - 7));
                    if (filtroTempoAttuale === '30days') return d >= new Date(new Date().setDate(today.getDate() - 30));
                    if (filtroTempoAttuale === 'this_year') return d.getFullYear() === now.getFullYear();
                    return true;
                });
            }
            renderTabella(datiFiltrati); if(currentUserRole === 'admin') aggiornaDashboard(datiFiltrati);
        }

        function caricaStrutturaImpianti() { db.collection("configurazioni").doc("impianti").onSnapshot((doc) => { if (doc.exists) { strutturaAzienda = doc.data(); } else { strutturaAzienda = {}; db.collection("configurazioni").doc("impianti").set({}); } aggiornaSelectImpianti(); renderStrutturaUI(); }); }
        function aggiungiImpiantoFirebase() { const imp = document.getElementById('nuovoImpianto').value.trim(); const mac = document.getElementById('nuoveMacchine').value; if(imp && mac) { strutturaAzienda[imp] = mac.split(',').map(m => m.trim()).filter(m => m !== ""); db.collection("configurazioni").doc("impianti").set(strutturaAzienda); document.getElementById('nuovoImpianto').value=''; document.getElementById('nuoveMacchine').value=''; } }
        function eliminaImpiantoUI(nome) { if(confirm(`Eliminare "${nome}"?`)) { delete strutturaAzienda[nome]; db.collection("configurazioni").doc("impianti").set(strutturaAzienda); } }
        function renderStrutturaUI() { const c = document.getElementById('strutturaImpiantiRender'); c.innerHTML = ''; for(let imp in strutturaAzienda) c.innerHTML += `<div class="impianto-item"><div class="impianto-item-header"><strong>${imp}</strong><button onclick="eliminaImpiantoUI('${imp}')" class="btn-small btn-delete">Elimina</button></div><div style="font-size:12px;">Macchine: ${strutturaAzienda[imp].join(', ')}</div></div>`; }
        function aggiornaSelectImpianti() { const s = document.getElementById('impiantoSelect'); s.innerHTML = '<option value="" disabled selected></option>'; for (let i in strutturaAzienda) s.innerHTML += `<option value="${i}">${i}</option>`; }
        function aggiornaMacchineForm() { const imp = document.getElementById('impiantoSelect').value; const s = document.getElementById('macchinaSelect'); s.innerHTML = '<option value="" disabled selected></option>'; if(strutturaAzienda[imp]) strutturaAzienda[imp].forEach(m => s.innerHTML += `<option value="${m}">${m}</option>`); }
        function salvaImpostazioneBase(k, i, d) { localStorage.setItem(k, document.getElementById(i).value); if(d) document.getElementById(d).innerText = document.getElementById(i).value; aggiornaVista(); }
        function salvaColoreTema() { const c = document.getElementById('setColoreTema').value; localStorage.setItem('coloreTema', c); document.documentElement.style.setProperty('--theme-color', c); aggiornaVista(); }
        function toggleTema() { const d = document.getElementById('themeToggle').checked; localStorage.setItem('darkMode', d); d ? document.body.setAttribute('data-theme', 'dark') : document.body.removeAttribute('data-theme'); Chart.defaults.color = d ? '#e0e0e0' : '#2b2b2b'; aggiornaVista(); }
        function aggiungiCategoria() { const c = document.getElementById('nuovaCategoria').value.trim(); if(c && !categorieLavoro.includes(c)) { categorieLavoro.push(c); localStorage.setItem('categorieLavoro', JSON.stringify(categorieLavoro)); document.getElementById('nuovaCategoria').value = ""; aggiornaListaCategorie(); } }
        function eliminaCategoria(i) { categorieLavoro.splice(i, 1); localStorage.setItem('categorieLavoro', JSON.stringify(categorieLavoro)); aggiornaListaCategorie(); }
        function aggiornaListaCategorie() { const ul = document.getElementById('listaCategorie'); ul.innerHTML = ""; categorieLavoro.forEach((c, i) => { ul.innerHTML += `<li>${c} <button onclick="eliminaCategoria(${i})" style="border:none;background:none;color:red;cursor:pointer;">[x]</button></li>`; }); const s = document.getElementById('causa'); s.innerHTML = '<option value="" disabled selected></option>'; categorieLavoro.forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`); }
        function apriImpostazioni() { document.getElementById('settingsModal').style.display = 'flex'; }
        function chiudiImpostazioni() { document.getElementById('settingsModal').style.display = 'none'; }

        function caricaDatiStorico() { db.collection("manutenzioni").orderBy("data", "desc").onSnapshot((qs) => { datiCorrenti = qs.docs.map(doc => ({ id: doc.id, ...doc.data() })); aggiornaVista(); }); }

        function renderTabella(dati) {
            const tbody = document.getElementById('tabellaStorico'); tbody.innerHTML = '';
            if(dati.length === 0) return tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Nessun intervento.</td></tr>';
            dati.forEach((record) => {
                const deleteBtnHtml = currentUserRole === 'admin' ? `<button class="btn-small btn-delete" onclick="eliminaRecord('${record.id}')">Elimina</button>` : '';
                let fotoBtnHtml = record.foto ? `<a href="${record.foto}" target="_blank" class="btn-small btn-foto">üì∑ Foto</a>` : '';
                const row = document.createElement('tr');
                row.innerHTML = `<td>${record.data}</td><td><span style="background:var(--border-color); padding:3px 6px; border-radius:3px; font-size:12px; color:var(--text-color);">${record.impianto || '-'}</span></td><td><strong>${record.macchina}</strong></td><td>${record.causa}</td><td>${record.ore}</td><td>${record.operatore || '-'}</td><td>${record.materiale}</td><td class="azione-btns">${fotoBtnHtml}<button class="btn-small btn-pdf" onclick="generaPDF('${record.id}')">PDF</button>${deleteBtnHtml}</td>`;
                tbody.appendChild(row);
            });
        }

        function aggiornaDashboard(dati) {
            let ore = 0; let guasti = {}; let cause = {}; let oreMacchine = {};
            dati.forEach(r => { let o = parseFloat(r.ore) || 0; ore += o; if(r.causa.toLowerCase().includes("guasto")) guasti[r.macchina] = (guasti[r.macchina] || 0) + 1; cause[r.causa] = (cause[r.causa] || 0) + 1; oreMacchine[r.macchina] = (oreMacchine[r.macchina] || 0) + o; });
            const costo = ore * (parseFloat(localStorage.getItem('costoOrario')) || 0);
            let peggior = "-", maxG = 0; for (let m in guasti) { if (guasti[m] > maxG) { maxG = guasti[m]; peggior = m; } }
            document.getElementById('statOre').innerText = ore + " h"; document.getElementById('statCosti').innerText = costo.toFixed(2).replace('.', ',') + " ‚Ç¨"; document.getElementById('statMacchina').innerText = peggior !== "-" ? `${peggior} (${maxG})` : "-";
            const theme = localStorage.getItem('coloreTema') || '#d32f2f';
            if (chartCauseInstance) chartCauseInstance.destroy(); chartCauseInstance = new Chart(document.getElementById('graficoCause').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(cause), datasets: [{ data: Object.values(cause), backgroundColor: [theme, '#1976d2', '#388e3c', '#fbc02d', '#8e24aa', '#e64a19'] }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Ripartizione Cause' } } } });
            let macchineOrd = Object.keys(oreMacchine).sort((a,b) => oreMacchine[b] - oreMacchine[a]).slice(0, 10);
            if (chartMacchineInstance) chartMacchineInstance.destroy(); chartMacchineInstance = new Chart(document.getElementById('graficoMacchine').getContext('2d'), { type: 'bar', data: { labels: macchineOrd, datasets: [{ label: 'Ore Totali', data: macchineOrd.map(m=>oreMacchine[m]), backgroundColor: theme, borderRadius: 4 }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Top 10 Macchinari' } }, scales: { y: { beginAtZero: true } } } });
        }

        document.getElementById('manutenzioneForm').addEventListener('submit', async function(e) {
            e.preventDefault(); 
            const btn = document.querySelector('button[type="submit"]'); btn.innerText = "Salvataggio..."; btn.disabled = true;
            let fotoUrl = null; const fileInput = document.getElementById('fotoIntervento'); const file = fileInput.files[0];
            try {
                if (file) {
                    const formData = new FormData(); formData.append("image", file);
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=ca1eba0dbe6bec04db06e2b264d34261`, { method: "POST", body: formData });
                    const data = await response.json(); if (data.success) fotoUrl = data.data.url;
                }
                const nr = { data: document.getElementById('data').value, operatore: document.getElementById('operatore').value, impianto: document.getElementById('impiantoSelect').value, macchina: document.getElementById('macchinaSelect').value, causa: document.getElementById('causa').value, ore: parseFloat(document.getElementById('ore').value), materiale: document.getElementById('materiale').value || "", foto: fotoUrl };
                await db.collection("manutenzioni").add(nr);
                document.getElementById('manutenzioneForm').reset(); document.getElementById('data').valueAsDate = new Date(); btn.innerText = "Registra Intervento"; btn.disabled = false; 
            } catch (err) { alert("Errore: " + err.message); btn.innerText = "Registra Intervento"; btn.disabled = false; }
        });

        function eliminaRecord(id) { if(confirm("Eliminare l'intervento?")) db.collection("manutenzioni").doc(id).delete(); }

        function generaPDF(idScelto) {
            const r = datiCorrenti.find(rec => rec.id === idScelto); if(!r) return;
            document.getElementById('pdfTitoloAzienda').innerText = localStorage.getItem('titoloAzienda') || "Azienda";
            document.getElementById('pdfData').innerText = r.data; document.getElementById('pdfImpianto').innerText = r.impianto; 
            document.getElementById('pdfMacchina').innerText = r.macchina; document.getElementById('pdfCausa').innerText = r.causa; 
            document.getElementById('pdfOre').innerText = r.ore; document.getElementById('pdfOperatore').innerText = r.operatore || "-"; 
            document.getElementById('pdfMateriale').innerText = r.materiale || "-";
            const cF = document.getElementById('pdfContainerFoto'); const iF = document.getElementById('pdfFotoIntervento');
            if (r.foto) { iF.src = r.foto; cF.style.display = 'block'; } else { iF.src = ""; cF.style.display = 'none'; }
            const h = document.querySelector('header'); const d = document.getElementById('pannelloStatistiche'); const m = document.querySelector('.main-content'); const mod = document.getElementById('settingsModal'); const p = document.getElementById('pdfTemplate');
            h.style.display = 'none'; d.style.display = 'none'; m.style.display = 'none'; mod.style.display = 'none'; p.style.display = 'block'; 
            setTimeout(() => { window.print(); p.style.display = 'none'; h.style.display = 'flex'; m.style.display = 'flex'; d.style.display = ''; applicaPermessiUI(); }, 500);
        }

        function esportaCSV() {
            if (datiFiltrati.length===0) return alert("Nessun dato.");
            let c = "data:text/csv;charset=utf-8,\uFEFFData;Impianto;Macchina;Tipo;Ore;Operatore;Foto;Dettagli\r\n";
            datiFiltrati.forEach(r => { c += `${r.data};${r.impianto};${r.macchina};${r.causa};${r.ore.toString().replace('.',',')};${r.operatore || '-'};"${r.foto || ''}";"${r.materiale.replace(/(\r\n|\n|\r)/gm," ")}"\r\n`; });
            let l = document.createElement("a"); l.href = encodeURI(c); l.download = "storico.csv"; document.body.appendChild(l); l.click(); document.body.removeChild(l);
        }
        window.onclick = function(e) { if (e.target == document.getElementById('settingsModal')) chiudiImpostazioni(); }
    </script>
</body>
</html>